<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión</title>
    <!-- Agregamos jQuery -->
    <script src="{{ url_for('static', filename='lib/jquery-3.7.1.min.js') }}"></script>
</head>
<body>
    <h1>Iniciar Sesión</h1>
    <form id="login-form">
        <label for="nick">Nick:</label>
        <input type="text" id="nick" name="nick" required>
        <br>
        <label for="password">Contraseña:</label>
        <input type="password" id="password" name="password" required>
        <br>
        <button type="submit">Iniciar Sesión</button>
    </form>

    <div id="response"></div>
    <script>
        $(document).ready(function() {
            $("#login-form").submit(function(e) {
                e.preventDefault();
                
                // Obtener los valores del formulario
                var nick = $("#nick").val();
                var password = $("#password").val();

                // Hashear la contraseña utilizando crypto.subtle
                window.crypto.subtle.digest('SHA-256', new TextEncoder().encode(password))
                    .then(function(hashBuffer) {
                        // Convertir el resultado del hash a una cadena hexadecimal
                        var hashArray = Array.from(new Uint8Array(hashBuffer));
                        var hashHex = hashArray.map(byte => byte.toString(16).padStart(2, '0')).join('');
                        
                        // Enviar la contraseña hasheada al servidor
                        $.ajax({
                            type: "POST",
                            url: "/login",
                            data: JSON.stringify({ "nick": nick, "password": hashHex }),
                            contentType: "application/json",
                            success: function(response) {
                                // Manejar la respuesta del servidor aquí
                                if (response.access_token) {
                                    $("#response").html("Inicio de sesión exitoso.");
                                    // Puedes redirigir al usuario a una página protegida aquí
                                } else {
                                    $("#response").html("Error en las credenciales.");
                                }
                            },
                            error: function(e) {
                                $("#response").html("Error en la solicitud.");
                                console.log(e);
                            }
                        });
                    })
                    .catch(function(err) {
                        console.error(err);
                    });
            });
        });
    </script>
</body>
</html>
